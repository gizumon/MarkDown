---
tag:
  - Workshop
---

# Salesforceアプリケーションビルダー基礎

```
・ 講師: 北山 圭介さん
・ 実施場所: 三田研修センター
```

* [研修テキスト](https://salesforce.mimeo.digital/library)  

---
# Agenda
---
* [ __前置き__](#前置き)  
* [ __module1: AWコンピュータ社__](#module1-awコンピュータ社)
* [ __module2: データモデルの宣言的な作成__](#module2-データモデルの宣言的な作成)
* [ __module3: ユーザーインターフェースの作成__](#module3-ユーザーインターフェースの作成)
* [__module4: モジュールのアジェンダと学習テーマ__](#module4-モジュールのアジェンダと学習テーマ)
* [__module5: レコードとデータセキュリティの保持__](#module5-レコードとデータセキュリティの保持)
* [__module6: ビジネスプロセスの自動化__](#module6-ビジネスプロセスの自動化)

---
# 前置き
## Salesforceとは
  * 世界TOPシェアのCRM(Customer Relationship Management)ソフトウェア
    * お客様の情報を管理するグループ = `CRM`
  * force.com => lightning platform
  * Salesforce全体のイメージ  
    ![SalesforceImage](https://gizumon.github.io/MarkDown/images/研修/SalesforceImage.PNG)  
  * 年にバージョンアップが3回(2月, 6月, 10月)
    * 自動で全ユーザー向けに適用される
    * 日本契約の場合、日本の週末深夜帯でバージョンアップ

## Salesforceサーバー
  * __マルチテナント__
    * 複数の会社の情報が同じサーバー上に存在
    * 一般的なクラウドでも同様
  * 組織(Organization)
    * 個々の会社を組織と呼ぶ
  * CPU、メモリの制限
    * 各組織単位で管理。
    > Q. CPU/メモリの上限を上げたい場合は、オプションがある？  
      ```
      A. ハードリミットあるものないものがある。  
        サポート対応が手厚いため、都度都度問い合わせて確認がベストとのこと。
      ```

# module1: AWコンピュータ社
  * 研修内で使う架空の会社
  * 中途採用向けの新規アプリケーション構築を例として、ケーススタディ

## 独自機能作りこみに関数開発手法
* `宣言的カスタマイズ`と、`プログラミング的カスタマイズ`方法がある。

### 宣言的カスタマイズ
  * 設定メニューから設定をしていく
  * 簡易に開発ができるが、汎用的なものがメイン
  * 単体テストレベルはSF側で担保。開発者は結合テストレベルの確認でOK。
  * バージョンアップの影響を受けにくい。
  * __本研修のターゲット__

### プログラミング的カスタマイズ
  * 上記の宣言的なカスタマイズで満たせない様なニーズはプログラミングでキャッチアップ
  * SF上の開発と、通常の開発は同じ規模感と考えてOK。
  * SF上の開発では、`データモデル`から考えていく必要がある。
    * 例：どんな情報が必要か。どんなテーブルが必要か。
  * SFサーバー上で動かしたいコードは`Apex`を用いて、開発をしていく。(Java, C言語に近い言語)

## Agile的な開発が多い
  > Q. 評価が大事だと思うが、SFにおけるAgile評価ってどのようなイメージ？フロントエンドだと、画面などUIちっくAgile評価が多いと思うが、  

## Sandbox
### メタデータ
* 設定情報のかたまり
* プログラムも含む
* XML形式でDL可能
* `SFで開発する = メタデータの編集`
### SandBoxの役割
* 本番組織のメタデータは開発用に触れないが、テスト環境には使いたい。
* Sandboxは本番組織のデータをコピーした`別の組織`
  > Q. Sandboxは作成した時の状態をコピー？それとも常に同期?
* Sandboxにコピーして、開発・テストしたメタデータを本番環境に反映。

### Sandboxの作成
* 開発者用画面
  * クイック検索 -> sandbox検索
  * Sandboxの種類はライセンス(Edition)により決まる
    * Developer, Developer Pro, Partial Copy, Full
      * 基本的にはストレージサイズの違い
      * Developerがついている種類では、メタデータのみがコピー
      * Proではレコードもコピーされる
  > Q. 作成のタイミングでApexクラスが指定できるが、これはなにか？
  ```
  Apexクラスはプログラミング開発的な方法で指定、あまり使われない。
  ```

* 補足：リリースタイミングの約1カ月前にSandboxに次回バージョンがリリースされる。
  * リリースノートを見て、影響ある場合は確認した方がベター

### お金のかからない開発環境
* Developer Edition
  * SFの開発者コミュニティ
    * developer editionの入手、無料でフル機能、無期限で使用可能
    * ライセンスが本番利用できない、ストレージが小さい
    * 開発者毎に作成OK
  * `推奨の開発方法`
    * Developer Edition: 各開発者で使用
    * Sandbox: 各開発者がDeveloper Editionで開発したものを持ち寄り、結合試験
* スクラッチorg
  * ガチ開発者向け

---
# module2: データモデルの宣言的な作成
---
## 基本用語
* オブジェクト
  * DBのテーブルに該当
* レコード
  * DBのレコード(タプル, 行)に該当
* 項目
  * DBのカラム(属性, 列)に該当
* 標準~
  * SF側で用意した要素のこと(例: 標準オブジェクト)
* カスタム~
  * 独自に追加した要素のこと(列: カスタムオブジェクト)
### 基本用語(画面周り)
* 選択リスト
  * ドロップダウンリスト
* 関連リスト
  * 一覧表(オブジェクト)の一種類、子供のレコードのリスト
* ルックアップ
  * 虫眼鏡のアイコン
  * 内部的にはID参照している
* 親子関係
  * １対多の関係の場合,１側が親。多側が子。  
   ![親子とUI上の見え方](https://gizumon.github.io/MarkDown/images/研修/親子とUI上の見え方.PNG)

## スキーマビルダー
* オブジェクト情報を参照してE-R図を生成してくれる
  > Q. E-R図を出力する機能はあるか。
  ```
  出力機能はなし、ハードコピーで対応
  ```

## 標準オブジェクトとカスタムオブジェクト
オブジェクトの作成は、宣言的な開発手法でしかできない。

### カスタムオブジェクト
* 組織事に後から追加した表
* カスタムオブジェクトを生成時、7つの標準項目が自動でできる
  * id
  * name　(テキスト or 自動採番)
    * label (多言語対応用)
  * CreatedById (作成者)
  * OwneredById (所有者 / アクセス権の付与が可能)
  * LastModifiedById
  * 最終更新日 / 作成日時
* カスタムオブジェクトはリレーションの設定が必要
* カスタムオブジェクトは `[テーブル名]__c` になる
* `レポート`機能では、集計や一覧表示が可能
  > Q. カスタムオブジェクトでは、標準項目のidが主キーになると思うが、任意のキーを主キーにはできない？
  ```
  できない。SFでは常にidで固定。ユニークな設定は可。
  ```

## オブジェクトリレーション
### データ型
* __参照関係__
* __主従関係__

  |項目|参照関係|主従関係|
  |---|---|---|
  |概要|緩やかな連携|密連携|
  |ルックアップ|空欄OK|空欄NG|
  |自己参照|可|不可|
  |所有者|別々OK|同じ|
  |親削除|アラート or 許容|一緒に消えちゃう|
  |積み上げ集計|不可|可 ※このケースのみ需要がある|
  |親子関係| - |親：標準/カスタム, 子：カスタム|
  |空白許容|許容|不許可|

### 自己参照
  * オブジェクトをオブジェクト自身とリンクする
    * 例：取引先オブジェクトの取引先親会社

* __階層__ (ユーザーオブジェクトにおける自己参照)
  * あるユーザーを別のユーザーにリンクする
  * 承認プロセスでの使用が一般的


### 多対多リレーション
  * 多対多のパターン
    * 参照関係 × 2
    * 参照関係 + 主従関係
    * 主従関係 × 2 = `連結オブジェクト`
      * 連結オブジェクトは、主従関係の親オブジェクトになれなくなる  
      ![連結オブジェクト](https://gizumon.github.io/MarkDown/images/研修/連結オブジェクト.PNG)  

### 子リレーション名
  * 子リレーション名は親オブジェクトに登録される
    * 親オブジェクトが別の場合、同一の名前でも問題なし。
  * 子リレーション名は一般に複数系で定義する

### ルックアップ検索条件
* 以下でルックアップ検索条件を設定する
  * 項目 × 演算子 × 値/項目 × 項目
* 有効化無効化のチェックに注意

## レコードのインポート
* `CSV形式`でデータをアップロード
   * インポートウィザード
   * データローダ(dataloader.io)

|項目|インポートウィザード|データローダ|
|---|---|---|
|使用環境|開発画面内で実行可|インストールが必要|
|制限|商品・商談の項目が対応なし|対応|
|全角対応|一部文字化け|問題なし|
|Maxレコード|5万件以下|500万以下|
|レコード重複|回避|回避なし(主キー or 外部IDが必要)|
|データの出力/削除|△(他画面で)|〇|
|インポートのスケジューリング|×|〇|

* 以下の場合、作成日時と作成者に任意の値を入れることも可能
  * APIベースのデータ管理ツールからのみアクセス可能
    > Q. インポートウィザード、データローダ、dataloder.ioはAPIでない?
  * ユーザーが「レコードの作成時に監査項目を設定」にチェックがついている状態

## データの更新
* 既存レコードのカスタム属性にデータを追加可能

### SalesforceのレコードID
* 注意：各レコードは、`15桁`のIDと`18桁`のIDを持つ
* `18桁`の場合、3桁は大文字・小文字の識別子

## データの追加/更新 (アップサート:Upsert)
* IDと外部IDどちらかを指定して、アップサート
  * 一致するIDが存在しない場合、追加
  * 1件のみ存在する場合、更新
  * (外部ID使用している場合) 2件以上存在する場合、エラー発報

### 外部ID
* SF以外のテーブルIDとして使用されていたIDなど、SFが用意したID以外の任意主キー
* 外部IDはユニークを保障はしない。処理側でエラーを出す
* 成功時、失敗時の挙動はAPIを使用するツールによって異なる
* 旧レコードに外部キーが存在する場合
  * 親のオブジェクトにも外部IDを設定していれば、  
    外部IDを使って外部キーをSFのIDに更新してくれる。
> 外部IDで、外部キーを更新する挙動のイメージはどんな感じ？
  ```
  CSVを取り込む際、レガシーのリレーションを引き継ぐ、
  外部キーと外部IDのリレーションの設定をする。
  これはAPIでも同様で、パラメータでリレーションを設定して更新しないと、
  リレーションを引き継いで更新はできない。
  ```
---
# module3:ユーザーインターフェースの作成
---

## 変えられるもの
* アプリケーションタブに表示可能なもの(タブ=オブジェクト)
* アプリケーションタブの順番
* リストビューのSelect項目(or Kanbanリストビュー)

## Kanbanリストビュー
* 看板では数値の項目を集計基準
* 選択リストの項目をグループ化単位として集計可能

## クイックアクション
* オブジェクト固有のクイックアクション
  * 作成 / 更新 / メール送信 / 活動記録 / カスタムアクション
* グローバルクイックアクション
  * 作成 / メール送信 / 活動記録 / カスタムアクション  

## レイアウト設定
* レコードページ
  * レコード詳細画面全体の配置
  * Lightningアプリケーションビルダーで編集 
* ページレイアウト
  * レコード詳細画面内の「詳細」、「関連」タブの配置
  * ページレイアウト
* 必須入力バリデーション 
  * ページレイアウトから画面の必須入力バリデーションをかけることが可能。
  * `項目自体の非NULL制約ではないこと注意`

## レコードタイプ
* 同じテーブルには入るが、用途・入力が別れるものをレコードタイプに応じて分けることができる。
* レコードタイプで指定できる項目は以下の通り
  * 名前
  * 選択リスト項目の選択肢
* ページレイアウトでは、レコードタイプによって出し分けが可能
* 選択されたレコードタイプは、標準項目として設定時に追加される。
* 選択されていない場合、マスタが適用される
  > レコードタイプを戻す場合、NULLで更新?マスタで更新?

```
Memo: システム挙動としてスマートな仕組み
同じテーブルで必須情報の制限分けをしたい場合、
RecordTypeの様な、レコードのタイプに応じて入力を制限する。
=> データの整合性はどうするか。は課題。
   SFでは、保存時チェックと合わせることで、整合性を担保可能。
```

> Q. レコードタイプを編集した場合、入力必須項目の整合性などはどうなるか。
  ```
  担保できないが、保存チェックなどと合わせることで制御可能。
  ```

> Q. 「レコードタイプを使って良い権限」とは、変更できるユーザー？それとも参照できるユーザー？
  ```
  明日の研修で分かる予定
  ```
---
# module4: モジュールのアジェンダと学習テーマ
---
## 数式項目
  * オブジェクト内の項目同士の演算で導出できる項目
    * リレーションをたどり、親の項目の情報を使うことも可能
    * 子の情報はN個あるため、たどれない不可
  * オブジェクトの項目として持たない。エクスポートや検索項目としては使えない
  * クロスオブジェクト数式
    * 計1o個までたどることができる(数式が複数ある場合は合計)

## 積み上げ集計項目の作成
  * 主従関係のみ、使える機能。
  * 親レコードの中に子レコードの集計結果を表示可能
    * 数式項目では、親レコードの情報しか引っ張れない(子はNなため)
  * 子供のレコードの集計結果項目は以下の通り
    * 件数
    * 最大
    * 最小
    * 合計
    * (平均) ※合計と件数から算出
  * 積み上げ集計はオブジェクトの項目として、登録される

|項目|数式項目|積み上げ集計項目|
|---|---|---|
|集計対象|親レコード|子レコード|
|レコードの更新|なし(参照のみ)|あり(更新)|
|集計式|任意式|件数、最大、最小、合計|
|関係|参照・主従|主従のみ|
|備考|検索値にできない|更新に伴い様々な処理が動く|

## 入力規則
* 宣言的 and プログラミング的両方で指定可能
  * プログラミング的な手法では、外部システムの情報と整合性合わせるなどが可能
* 規則が`TRUE`だとエラーになる
* 入力規則は作成済みの項目に作用しない。
  * レコード保存時に動く
* 必須入力は、指定できる場合と指定できない場合がある。
  * そういうケースでは、入力規則で必須入力バリデーションをつける。
* 注意：
  * `レコードIDで規則はNG`
    * `sandboxと本番環境でレコードIDは変わる`
  * 標準要素のラベル、名前は数式内に入れない方がよい
    * `各国対応で正常にうまく動作しない場合がある`
    > あくまでページのバリデーション?画面以外からは規則すり抜けられる？  
      ```
      レコード保存時に必ず動く。そのため、データローダやAPIからもこの規則が適用される。
      ```

    > アラートは出すけど、登録できるとか緩い設定があるか  

    > DBとして非NULLを担保できるのは、項目の必須入力チェックのみ?  
      ```
      非NULLにできるのは、
      項目の必須入力、ページレイアウト、入力規則の３つ。
      どれも既存のレコードに対しては作用しないため、担保はできない。
      ただ、チェックつけたあとは、
      項目のプロパティ、入力規則は、全てのレコード登録・更新のタイミングで値があることを担保。
      ```

|項目|項目のプロパティ|ページレイアウト|入力規則|
|---|---|---|--|
|対象のレコード|全て|画面|全て|
|UI|必須マーク付き|必須マーク付き|必須マークなし|

---
---
# module5: レコードとデータセキュリティの保持
* SFの権限はホワイトリスト式。権限の許可を付与していく
## ユーザーの権限
### プロファイル
  * 権限(許可)の大きなかたまり
  * 権限周りのトラブルでは、もっとも可能性の高い箇所
  * ユーザー１人に対して必ず１つ設定する
  * プロファイルは職種をグループとして用意するのが、ベストプラクティス
  * CRUD(Update = Edit)ベースでオブジェクトに権限がつく
  * 最低の権限(一番少ない人の権限で作成する)
  * どのライセンスで使えるか決まる

## 権限セット
  * 権限のかたまり(一部プロファイルより少ない)
    * バッティングすると困るものは、プロファイルで設定される
  * ユーザー毎に0 ~ N個割りてられる
  * プロファイルと権限セット(× N)の権限は`足し算`になる
    * できることを減らすことはできない
  * ライセンスを縛る、縛らないOK

    > 権限の重ねがけはできるか。技術、営業、上司
      ```
      プロファイルは１ユーザーに１つ。
      権限セットはいくつでもつけられる。
      ```

## アクセス権の単位
* [オブジェクト](#オブジェクトのアクセス権)
* [レコード](#レコードのアクセス権)
* [項目レベルセキュリティ](#項目レベルセキュリティ)

  ![権限](https://gizumon.github.io/MarkDown/images/研修/権限.PNG)  

    > 権限がホワイトリストで与えられることは統一?  
    ```
    そのルールは統一。
    ただし、オブジェクト、レコード、項目レベルセキュリティ
    全てに権限を持っていないと目的の操作ができない。
    ```
    > オブジェクト、レコード、項目レベルセキュリティに権限の優先度はある?  
    ```
    独立している。
    例えば、更新をしたい場合、
    　オブジェクトの更新権限があるかつ、
    　レコードの更新権限があるかつ、
    　項目レベルの更新権限がある
    状態でなくては目的の操作まで到達できない
    ```
    > 項目レベルセキュリティと項目アクセス許可の違いは？セキュリティは項目で、アクセスはレコード？？の感じ?
    ```
    関係なし。"セキュリティ"と"アクセス"に特別なルールはない模様
    切り分けて考えた方がいい
    ```
## 項目レベルセキュリティ
  * プロファイルや、権限セットを使って制御
  * 権限は項目レベルセキュリティで設定
    * ページレイアウトよりも強い設定

## オブジェクトのアクセス権
* ユーザーのプロファイル、権限セットから与えられる
* [上を参照](#ユーザーの権限)

## レコードのアクセス権

|所有者|所有者以外|
|---|---|
|フルアクセス権|組織の共有設定 (なし、参照、更新)|
|-|ロール(役職)階層|
|-|共有ルール|
|-|手動共有|

* レコードのアクセス権
  * なし
  * 参照
  * 参照 / 更新
  * フルアクセス権 (参照/更新/所有権の移行/削除/共有)
    * フルアクセス権は基本的に所有者や管理者が持つ
* ロール：アクセス権を増やすために設定する項目
  * レコードのアクセス権のみ下位職から引き継ぐ
  * レコードのアクセス権は下位職から全て引き継ぐ(下位職何段階分も引き継ぐ)
* 共有ルール：なし、参照、更新のみ
* 手動共有設定
  * 共有の直接設定

### 所有者
* 全てのオブジェクトに所有者がいる
* 主従関係オブジェクトの従オブジェクト以外は変更可

### キュー
* 複数人のグループが所有者(所有者)になれる
* キュー：所有者待ちの状態  
  * リストビューの一覧から、キューが所有者の一覧が出る

> プロファイルは最低の権限で作成して、権限セットで補充。  
  レコードのアクセス権、項目のアクセス権は、あり得る最大の権限の認識OK？

## 公開グループ
* 以下の単位で汎用的に操作対象とするグループを作成可能
  * 個人ユーザー
  * ロール
  * ロール & 下位ロール
  * 他の公開グループ
    * `ユーザー単位は手動メンテナンスが必要になる`
      * ロールベースが推奨

## 共有オプション
* 優先度
  * 共有ルール
  * 共有の直接設定
  * Apexまたは、フローによる共有(※プログラミング的な開発)

## システム権限 (プロファイル)
* 全てのデータの参照
* 全てのデータの編集
  * `レコードのアクセス権より優先される。`

## オブジェクト権限 (オブジェクト)
* すべて表示
* すべて変更
  * 特定のオブジェクトの全てのレコードへのアクセス権を付与
  > イメージは、オブジェクトの権限で、レコードのアクセス権もつける?

> Q. プロファイルで設定する権限は、オブジェクトの権限にあたる?
  ```
  オブジェクトの権限と、項目の権限が設定可能。
  ```

> Q. 設定のイメージ
  * オブジェクト：
    * プロファイルでがっつり見れる見れない、いじれるいじれないを切り分け
  * レコード：
    * 
  * 項目
    * 
---
---
# module6: ビジネスプロセスの自動化
### Sandboxのログイン
  * ユーザー名
    * 本番のユーザー名.sandbox名
  * パスワード
    * 本番のパスワード 
### Sandboxのログイン方法
  * ログインリンク
  * sandbox作成完了時のリンク
  * text.salesforce.com (データローダのURLに必要)

## プロセス
* Insert, Updateをトリガーに処理を実行
* Deleteの検知には、プログラムが必要
### Lightning プロセスビルダー
* プロセスの実行条件
  * 評価条件
    * どのオブジェクトにどの操作がされたら？
  * ルール条件
    * どういうレコードが実行されたら？
  * タイムトリガ
    * アクションをいつ実行しますか?
* 複数のアクションをタイミングを分けて実行できる
* スケジューリングチェックが15分に1回
  * 過去日付にスケジューリングされたものもこのタイミングで動く
* 同期処理が担保されている

> Q. プロセスのCRUD権限
  ```
  システム管理者の権限で動く
  操作ユーザーに権限がなくても作成、更新が可能
  ```

### Lightning プロセスビルダーのアクション
|アクション|説明| 
|:---|---| 
|レコード作成|新規なんでも| 
|レコード更新|リレーションのあるレコード| 
|メールアラート|テンプレートのメールを送信| 
|承認申請|レコードの承認申請を提出| 
|フロー|一部のフロー呼び出しを起動| 
|Apex起動|プログラム呼び出し|

  > Q. DELETEをすることはできない??  

  > Q. プロセスがエラーになった場合にどこでデバッグできるか  

      ```
      1. デバッグログの出力をオンにして、出力
      2. 開発者コンソールを開いた状態で操作
        →　コンソール内にログが出力
      ```

  > Q. プロセスのsandboxから本番環境への移行
  ```
  ```

<br>

## 承認プロセス
* 承認プロセスステップ
  1. 承認申請
    * 手動, プロセス/フロー, Apex/API
  2. 開始条件
    * 条件式、数式を使ってレコードチェック
  3. 申請時のアクション
    * レコードロック、ToDo、アラートなどなど
  4. 承認ステップ
    * 条件分岐、承認アクション or 却下アクション
  5. 最終承認時/最終却下時/取り消し時のアクション
* 承認申請内容
  * メール、アプリ
  * 承認申請タブ、カスタマイズしたホームページ、レコード詳細ページ


---
### その他
* APIの研修: インテグレーションがついている研修
* 資格試験対象者: `理解度チェックの解答`に近いテストが出る
* データベースの基本: 親から更新していくこと
* 導出項目: 項目から導出可能な項目
* 代理ログイン：管理者は別権限で動作確認できる。
